<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gather web admin</title>
  <style>
    .graphCanvas{
     
      border : 1px solid grey;
    }
  </style>
</head>
<body>
    <div>gather web admin, user:{{user}}</div>
    <div id="container"></div>
    <canvas id="chart" width="400" height="100"></canvas>
</body>
<script src="/js/smoothie.js" ></script> 
<script>
  const SMOOTHE_CONFIG={}
  var CHANNELCHART=new Map([])    //список id канала : объекты SmoothieChart 
  
  async function dataRequest(){
        let response = await fetch('/request', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({type: 'allStateQuerry'})
                            })
        return await response.json()
    }

  function wsConnect(){
    console.log('Socket opening');
    // return new WebSocket("{{ wsserv }}"+"?jjjj");
    return new WebSocket("{{ wsserv }}");
  }

  function wsEvents(){
    ws.onmessage = function(evt) {
            let JsonMsg = JSON.parse(evt.data);
            // console.log("JsonMsg")
            // console.log(JsonMsg)
            setDataById(JsonMsg)
            
          };
  
    ws.onclose = function(evt) {
        console.log(' Server close connection! No data!')
        //console.log(ws)
        let mbStatus = ' Server close connection! No data!';
    };

    ws.onopen = function(evt) {
        console.log(' Connection ok, receiving data...')
        let mbStatus = ' Connection ok, receiving data...';
        //wsSend(JSON.stringify({type:"msg",data:'hello from utrack client (map)'}))
    };
  } 

  let wsSend = function(data) {
    if(!ws.readyState){
        setTimeout(function (){
            wsSend(data);
        },1000);
    }else{
      ws.send(data);
    }
  };
  
  function setDataById(result){
    function setData(data){
      for (let i = 0; i < data.length; i++){
        if (data[i].id !=null){
          let elem= document.getElementById(data[i].id.toString())
          if (elem) {
            elem.innerHTML=data[i].result
            CHANNELCHART.get(data[i].id).seriesSet[0].timeSeries.append(new Date().getTime(), data[i].result)         //TODO только первый график, можно добавить ID + фильтр по нему
          }
        }
      }
    }
    setData(result.node)
    //setData(result.programm)
   
  }


  function makePage(result){
    console.log('makePage result-',result)
    let page= document.getElementById('container');
    page.innerHTML='';
    let container=document.createElement('div');
    container.classList=['mainContainer'];
    page.append(container);
    let nodes=result.nodes;
    let div=document.createElement('div');

    div.innerHTML='Nodes'
    container.append(div)
    for (var i=0; i<result.node.length; i++){
      p=document.createElement('div');
      p.innerHTML='id:'+result.node[i].id+' result:<span id='+result.node[i].id +'>'+result.node[i].result+'</span>'
      container.append(p)
      canvas=document.createElement('canvas');
      canvas.id='canvas_'+result.node[i].id
      canvas.width="300";
      canvas.height="70";
      container.append(canvas)
      chart = new SmoothieChart({millisPerPixel:60,maxValue:100,minValue:0,horizontalLines:[{color:'#ffffff',lineWidth:1,value:5},{color:'#880000',lineWidth:2,value:60}]});
      console.log(chart)
      chart.streamTo(canvas);
      line=new TimeSeries();
      chart.addTimeSeries(line, { strokeStyle: 'rgba(0, 255, 0, 1)',  lineWidth: 2 });
      CHANNELCHART.set(result.node[i].id, chart);
    };
    console.log(CHANNELCHART)
    ws=wsConnect()
    wsEvents()
  };

  //запрос первоначального сотояния
  dataRequest().then((result) => {
    makePage(result);
  });
</script>
</html>