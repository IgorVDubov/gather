<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utrack Idle service</title>

    <link rel="stylesheet" type="text/css" href="/css/header_main_footer.css"/>
    <link rel="stylesheet" type="text/css" href="/css/mycsslib.css"/>
    <script src="/js/moment-with-locales.min.js" ></script> 
    <style>  /*new style*/
        body{
          background-color:rgb(227, 227, 236);
          /* background-color:black; */
        }
        .pageSection1{
          /* width: 100%;
          height:100%; */
          width: 99.6%;
          display:flex;
          align-items:center;
          flex-direction:column;
        }
        .mainContainer{
          font-family: "Segoe UI", "Segoe WP", Arial, sans-serif;
          /* margin: 10px; */
          max-width:700px;
          max-width:700px;
          height:100%;
          display:flex;
          flex-direction: column;
          flex-wrap: wrap;
          /* flex-direction:column; */
          align-items:center;
          justify-content: space-evenly;
          /* justify-content: space-between; */
        }
        .flexH{
          display:flex;
          flex-direction:row;
          justify-content: space-evenly;
    
        }
        .w100{
          width:100%;
          min-width:300px;
          margin:5px;
        }
        .singleW50{
          min-width:300px;
          margin:5px;
        }
        .w50{
          flex:1 300px;
          min-width:300px;
          margin:5px;
        }
        .h50{
              min-height: 50px;
            }
        .h100{
              height: 100px;
            }
        .lowerFont{
          font-size: 0.6em;
          color:inherit;
    
        }
        .centerPosWrapper{
          width: 100%;
          display:flex;
          align-items:center;
          flex-direction: column;
        }
        .headerbox{
          /* flex:4; */
          margin: 5px;
          width: 100%;
          height: 50px;
          color: rgb(102, 103, 171);
          /* color: whitesmoke; */
          text-align: center;
          font-weight: bold;
          /* font-style: italic; */
          font-size: 30px;
        }
        @keyframes changeColor {
          0% {
            background-color: rgb(102, 103, 171);
          }
          
          50% {
            background-color: rgb(236, 82, 11);
          }
          
          100% {
            background-color: rgb(102, 103, 171);
          }
        }

        .flashBackground {
            background-color: rgb(236, 82, 11);
            animation: changeColor ease;
            animation-iteration-count: infinite;
            animation-duration: 0.5s;
            animation-fill-mode: both;
            }
        .databox{
          /* background-color: rgb(93, 91, 162); */
          background-color: rgb(102, 103, 171);
          border-radius: 10px;
          box-shadow: 2px 2px 5px 0px rgb(107, 107, 107);
        }
        .databox:hover{
          background-color: rgb(82, 83, 163);
        }
        .dataCaption{
          padding: 5px;
          text-overflow: clip;
          text-align: center;
          font-size: 24px;
          color:white;
          height: 40%;
          width: 100%;
        }
        .colorDataCaption{
          padding: 5px;
          text-overflow: clip;
          text-align: center;
          font-size: 24px;
          color:rgb(3, 224, 3);
          height: 40%;
          width: 100%;
        }
        .dataLable{
          text-align: center;
          width:100%;
          font-size: 32px;
          font-weight: bold;
          color:white;
        }
        .colorDataLable{
          text-align: center;
          width:100%;
          font-size: 32px;
          font-weight: bold;
          color:rgb(3, 224, 3);
        }
    </style>
    <style>
      .statusContainer{
        display:flex;

      }
    </style>
    <style> /* progress bar */
      .progressBar {
        border: solid, gray, 2px;
        border-radius: 3px;
        padding-left: 1em;
        padding-right: 1em;
        width: 100%;
        height: 1.5em;
        text-align: center;
        color: white;
        font-size: 1em;
      }
      .progress {
        background-color :aquamarine;
        width: 0%;
        height: 100%;
      }
    </style>
</head>
<body>
    <header class="header" >
        <span class="fnt_1_5 bold pl1"> <a  href="/">UTrack</a></span>
        <span class="pl1 fnt_0_75"> учет рабочего времени оборудования</span>
        <span class="userBlock fl_r pr1 ">
            <span>{{ user }} </span>
            <a href="/logout"> <img class="img_invert s1em" src="/images/icon-exit.png"> </a>
        </span>
      </header>
      <main class="main">
        <section class=pageSection1 id=container></section>
        <!-- <div id="container"></div> -->
        </main>  
        <footer class='footer'>
          <span class ="pl1"> Статус: </span> </span>
          <span class ="pl0_5" id="wsStatus"> </span>
          <span class ="pl0_5" id="wsLight"> &bull; </span>
          <a class="fl_r pr1" >v{{ version }}</a>
          <a class="fl_r pr1" href="mailto:asu@alfa33.ru">Alfa <span class="fnt_0_6 pr1">решения в области промышленной автоматизации</span> 2023</a>
      </footer> 
      <div id="loader">
          <script>const loader=document.getElementById("loader");</script>
          <link rel="stylesheet" type="text/css" href="/css/loader.css"/>
      </div>
</body>
<script>
    moment.locale('ru');
    const STATUS_LIGHT_COLORS=['#e6e6e6','#b4b4b4','#fff134','#03e003']
    const STATUSES =['N/A', 'Откл', 'Простой', 'Работа']
    const MACHINE_ID={{ machine }}
    const WS_SERVER = '{{ wsserv }}';
    {% autoescape None %}
    const IDLE_COUSES={{  idle_couses  }}
    const STATE_CHANNEL='{{state_channel}}'
    const CAUSEID_ARG='{{ causeid_arg }}'
    const TECH_IDLE_LENGTH={{ tech_idle }}
    const SUBSCRIBE_CHANNELS=[STATE_CHANNEL]
    const WORK_STATE=3
    const STAND_STATE=2
    const OFF_STATE=1
    const NA_STATE=0
    const TECH_IDLE_ID=-1
    var initState={{current_state}}
    var firstWsMessageFlag=false;    //при инициализации приходит сообщение о статусе и затирает ранее полученный, его пропускаем
    var idleTime
    var currentState=Object()
      currentState.state=initState.state;
      currentState.stateTime = (initState.begin_time!='None')?initState.begin_time:undefined;
      currentState.cause = (initState.cause_id!='None')?initState.cause_id:undefined;
      currentState.causeTime = (initState.cause_time!='None')?initState.cause_time:undefined;
        


    currentState = new Proxy(currentState, {
      set(target, property, value){
        if (value=='None'){
          value==undefined;
        } 
        target[property]=value;
        if (property=='state'){
            changeState()
        }
        if (property=='cause'){
            changeCause()
        }
        return true
      }
      });
    
    
    var stateElem
    var stateTimeElem
    var causeStatusElem
    var causeStatusTimeElem
    var causeButtonsContainerElem
    var changeCauseButtonElem
    var progressBarElem
    var progressElem
    
    var ws


    const FlashColor='rgb(255, 0, 0)'

    const wsStatus=document.getElementById("wsStatus")
    const wsIndicator=document.getElementById("wsLight")
    
    class PerodicalCallback {
        constructor(callback, delay, start=true) {
          this.callback = callback;
          this.delay=delay;
          this.remaining = delay;
          if (start) this.resume();
        }
        
        pause() {
          this.paused = true;
          window.clearInterval(this.id);
          this.remaining -= new Date() - this.start;
        }
        
        restart() {
          this.remaining = this.delay;
          this.resume();
        }
        
        resume() {
          this.paused = false;
          this.start = new Date();
          window.clearInterval(this.id);
          this.id = window.setInterval(this.callback, this.remaining);
        }
      }
    
    function block(innerHTML=undefined, classes=[], id=undefined, ){
      let block=document.createElement('div');
      if (id !=undefined) block.id=id;
      if (innerHTML !=undefined) block.innerHTML=innerHTML;
      block.classList=classes;
      return block;
    }
    function labledDataBlock(label, blockClasses=[],labelClasses=[],dataClasses=[], blockID=undefined, labelID=undefined, dataID=undefined){
        let container=block('',blockClasses,blockID);
        container.append(block(label,labelClasses,labelID));
        container.append(block('',dataClasses,dataID));
        return container
    }
    function labled2DataBlock(label, blockClasses=[],labelClasses=[],data1Classes=[], data2Classes=[], blockID=undefined, labelID=undefined, data1ID=undefined, data2ID=undefined, flexDirection='row'){
        let container=block('',blockClasses,blockID);
        container.append(block(label,labelClasses,labelID));
        let flexCls=(flexDirection=='row') ? 'flex_milldle_row':'flex_milldle_col'
        let dataContainer=block('',[flexCls],'');
        data1=block('',data1Classes,data1ID)
        data2=block('',data2Classes,data2ID)
        dataContainer.append(data1);
        dataContainer.append(data2);
        container.append(dataContainer);
        return container
    }
    function flashIndicator(indicator, flashColor,afterColor, pause){
      indicator.style.color=flashColor
      setTimeout(function(){indicator.style.color=afterColor},pause)
    }
    
    const secondsTimer=new PerodicalCallback ("updateStatusTime()", 1000,false);
    const techIdleTimer=new PerodicalCallback ("updateTechIdle()", 250,false);

    function wsConnect(WSServer){
      let ws=new WebSocket(WSServer);
      wsStatus.textContent='online'
      wsIndicator.style.color='green'
      return ws
        // return new WebSocket(WSServer);
    }

    function wsEvents(){
      ws.onmessage = function(evt) {
        let jsonMsg = JSON.parse(evt.data);
        console.log(jsonMsg)
        switch (jsonMsg.cmd) {
          case "reload":
              //console.log(jsonMsg.data)
              location.reload()
          break;
          default:
        }
        if (firstWsMessageFlag){
          firstWsMessageFlag=false
        } else {
          currentState.state=jsonMsg[0][STATE_CHANNEL]
          currentState.stateTime=jsonMsg[0].time;                                   //todo взять из запроса
        }
        flashIndicator(wsIndicator,'lightgreen','green',400);
      };
        
    
      ws.onclose = function(evt) {
          console.log(' Server close connection! No data!')
          wsStatus.textContent='offline'
          wsIndicator.style.color='Red'
      };

      ws.onopen = function(evt) {
          console.log(' Connection ok, send subscribe msg: ' + SUBSCRIBE_CHANNELS)
          wsSend(JSON.stringify({type:"subscribe",data:SUBSCRIBE_CHANNELS}))
      };
    } 

    let wsSend = function(data) {
          if(!ws.readyState){
              setTimeout(function (){
                  wsSend(data);
              },1000);
          }else{
            ws.send(data);
          }
    };

    function changeState(){
      setStatus(currentState.state)
      if (currentState.state==WORK_STATE){
        currentState.cause=undefined;
        currentState.causeTime=undefined;
        stopFlashIdleBox();
        hideCauseStatusContainer();
        hideCauseButtons();
        hideChangeCauseButton();
      } else{
        showCauseStatusContainer();
        if (currentState.cause==undefined){ 
          startFlashIdleBox();
          showCauseButtons();
        } 
      }
    }

    function changeCause(){
      // if (currentState.state!=WORK_STATE){
        if (currentState.cause!=undefined){  
          setCause();
          sendCause(currentState.cause);
        } else{
          waitCause()
        }
      // }
    }

    function setStatus(result){
      stateElem.style.color=STATUS_LIGHT_COLORS[result];
      stateElem.innerText=STATUSES[result];
    }
    function setCause(){
      stopFlashIdleBox();
      let causeTime = (currentState.causeTime==undefined) ?  moment() : currentState.causeTime
      setCauseStatus(currentState.cause, causeTime);
      hideCauseButtons();
      showChangeCauseButton();
    }
    function waitCause(){
      startFlashIdleBox();
      showCauseButtons();
      hideChangeCauseButton();
      setWaitCauseStatus();
    }
    function setCauseStatus(couseID,causeTime){
      causeStatusElem.innerText=IDLE_COUSES[couseID]
      causeStatusTimeElem.innerText=causeTime
    }
    
    function setWaitCauseStatus(couseID,causeTime){
      causeStatusElem.innerText='-'
      causeStatusTimeElem.innerText=''
    }
    
    function sendCause(couseID){
      wsSend(JSON.stringify({type:"set",arg:CAUSEID_ARG, val:parseInt(couseID)}))
    }
    

    function showCauseStatusContainer(){
      causeStatusContElem.style.display='block'
    }
    function hideCauseStatusContainer(){
      causeStatusContElem.style.display='none'
    }
    function updateStatusTime(){
        let d=moment.duration(moment().diff(currentState.stateTime),'ms')
        stateTimeElem.innerText=  d.hours() + ':' + d.minutes() + ':'+d.seconds()
    }
    function showCauseButtons(){
      causeButtonsContainerElem.style.display='block'
    }
    function hideCauseButtons(){
      causeButtonsContainerElem.style.display='none'
    }
    function showChangeCauseButton(){
      changeCauseButtonElem.style.display='block'
    }
    function hideChangeCauseButton(){
      changeCauseButtonElem.style.display='none'
    }
    
    function startFlashIdleBox(){
      causeStatusContElem.classList.add('flashBackground')
    }
    function stopFlashIdleBox(){
      causeStatusContElem.classList.remove('flashBackground')
    }
    
    function setProgress(progress,value){
      progressElem.style.width=progress.toString()+'%'
      //progressBarElem.innerText = value
    }
    function updateTechIdle(){
      idleTime= idleTime - 0.250;
      
      if (idleTime==0){
        var idleTime=TECH_IDLE_LENGTH;
        //techIdleTimer.pause()
        return
      } 
      if (TECH_IDLE_LENGTH%idleTime==0){
        var seconds=idleTime
      } 
      setProgress(100*idleTime/TECH_IDLE_LENGTH, seconds)

    }
    function clickHandler(event){
      currentState.cause=event.target.dataset.id;
    }
    
    function changeCauseclickHandler(){
      currentState.cause=undefined;
      currentState.causeTime=undefined;
    }
    
    function makePage(){
        let page= document.getElementById('container');
        page.innerHTML='';
        let container=document.createElement('div');
        container.classList=['mainContainer'];
        page.append(container);
        container.append(labled2DataBlock('состояние',['h100 w100 databox'],['dataCaption'],['dataLable'],['dataLable'],'','','state_'+MACHINE_ID,'stateTime_'+MACHINE_ID, 'row'))
        let causeBlock=labled2DataBlock('причина',['h100 w100 databox'],['dataCaption'],['dataLable, fnt_1_5'],['dataLable, fnt_1_5'],'causeStatus','','cause_'+MACHINE_ID,'causeTime_'+MACHINE_ID, 'row')
        container.append(causeBlock)
        let progressBar=block('',['progressBar'],'causeProgressBar')
        let progress=block('',['progress'],'causeProgress');
        progressBar.append(progress)
        causeBlock.append(progressBar)

        const causeButtonsContainer = block('',[],'causeButtonsContainer');
        for (i=0; i<Object.keys(IDLE_COUSES).length;i++){
          let id=Object.keys(IDLE_COUSES)[i]
          let cause=IDLE_COUSES[id]
          button=block(cause,['h100 w100 flex_center databox dataLable '],'buttonsContainer');
          button.dataset.id=id
          button.addEventListener('click', clickHandler);
          causeButtonsContainer.append(button)
        }
        container.append(causeButtonsContainer);
        let changeCauseButton=block('изменить причину простоя',['h100 w100 databox dataLable flex_center'],'changeCauseButton')
        changeCauseButton.addEventListener('click', changeCauseclickHandler);
        container.append(changeCauseButton);
    }

    function firstCurrentStateInit(){
      currentState.state=currentState.state;
      if (currentState.state!=WORK_STATE){
        if (currentState.cause!=undefined){  
          setCause();
        } else{
          waitCause();
        }
      }
    };

    function init(){
        makePage()
        console.log('start')  
        stateElem=document.getElementById('state_'+parseInt(MACHINE_ID))
        stateTimeElem=document.getElementById('stateTime_'+parseInt(MACHINE_ID))
        causeStatusContElem=document.getElementById('causeStatus')
        causeStatusElem=document.getElementById('cause_'+parseInt(MACHINE_ID))
        causeStatusTimeElem=document.getElementById('causeTime_'+parseInt(MACHINE_ID))
        causeButtonsContainerElem=document.getElementById('causeButtonsContainer')
        changeCauseButtonElem=document.getElementById('changeCauseButton')
        progressBarElem=document.getElementById('causeProgressBar');
        progressElem=document.getElementById('causeProgress');
        stateTime=moment(currentState.begin_time);
        secondsTimer.restart();
        idleTime=TECH_IDLE_LENGTH;
        techIdleTimer.restart();
        firstCurrentStateInit();
        ws=wsConnect(WS_SERVER);
        wsEvents();
    }
    
    init()
</script>
</html>