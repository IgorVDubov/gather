<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utrack Idle service</title>

    <link rel="stylesheet" type="text/css" href="/css/header_main_footer.css"/>
    <link rel="stylesheet" type="text/css" href="/css/mycsslib.css"/>
    <script src="/js/moment-with-locales.min.js" ></script> 
    <style>  /*new style*/
        body{
          background-color:rgb(227, 227, 236);
          /* background-color:black; */
        }
        .pageSection1{
          /* width: 100%;
          height:100%; */
          width: 99.6%;
          display:flex;
          align-items:center;
          flex-direction:column;
        }
        .mainContainer{
          font-family: "Segoe UI", "Segoe WP", Arial, sans-serif;
          /* margin: 10px; */
          max-width:700px;
          max-width:700px;
          height:100%;
          display:flex;
          flex-direction: column;
          flex-wrap: wrap;
          /* flex-direction:column; */
          align-items:center;
          justify-content: space-evenly;
          /* justify-content: space-between; */
        }
        .flexH{
          display:flex;
          flex-direction:row;
          justify-content: space-evenly;
    
        }
        .w100{
          width:100%;
          min-width:300px;
          margin:5px;
        }
        .singleW50{
          min-width:300px;
          margin:5px;
        }
        .w50{
          flex:1 300px;
          min-width:300px;
          margin:5px;
        }
        .h50{
              min-height: 50px;
            }
        .h100{
              height: 100px;
            }
        .lowerFont{
          font-size: 0.6em;
          color:inherit;
    
        }
        .centerPosWrapper{
          width: 100%;
          display:flex;
          align-items:center;
          flex-direction: column;
        }
        .headerbox{
          /* flex:4; */
          margin: 5px;
          width: 100%;
          height: 50px;
          color: rgb(102, 103, 171);
          /* color: whitesmoke; */
          text-align: center;
          font-weight: bold;
          /* font-style: italic; */
          font-size: 30px;
        }
        @keyframes changeColor {
          0% {
            background-color: rgb(102, 103, 171);
          }
          
          50% {
            background-color: rgb(236, 82, 11);
          }
          
          100% {
            background-color: rgb(102, 103, 171);
          }
        }

        .flashBackground {
            background-color: rgb(236, 82, 11);
            animation: changeColor ease;
            animation-iteration-count: infinite;
            animation-duration: 0.5s;
            animation-fill-mode: both;
            }
        .databox{
          /* background-color: rgb(93, 91, 162); */
          background-color: rgb(102, 103, 171);
          border-radius: 10px;
          box-shadow: 2px 2px 5px 0px rgb(107, 107, 107);
        }
        .databox:hover{
          background-color: rgb(82, 83, 163);
        }
        .dataCaption{
          padding: 5px;
          text-overflow: clip;
          text-align: center;
          font-size: 24px;
          color:white;
          height: 40%;
          width: 100%;
        }
        .colorDataCaption{
          padding: 5px;
          text-overflow: clip;
          text-align: center;
          font-size: 24px;
          color:rgb(3, 224, 3);
          height: 40%;
          width: 100%;
        }
        .dataLable{
          text-align: center;
          width:100%;
          font-size: 32px;
          font-weight: bold;
          color:white;
        }
        .colorDataLable{
          text-align: center;
          width:100%;
          font-size: 32px;
          font-weight: bold;
          color:rgb(3, 224, 3);
        }
    </style>
    <style>
      .statusContainer{
        display:flex;

      }
    </style>
</head>
<body>
    <header class="header" >
        <span class="fnt_1_5 bold pl1"> <a  href="/">UTrack</a></span>
        <span class="pl1 fnt_0_75"> учет рабочего времени оборудования</span>
        <span class="userBlock fl_r pr1 ">
            <span>{{ user }} </span>
            <a href="/logout"> <img class="img_invert s1em" src="/images/icon-exit.png"> </a>
        </span>
      </header>
      <main class="main">
        <section class=pageSection1 id=container></section>
        <!-- <div id="container"></div> -->
        </main>  
        <footer class='footer'>
          <span class ="pl1"> Статус: </span> </span>
          <span class ="pl0_5" id="wsStatus"> </span>
          <span class ="pl0_5" id="wsLight"> &bull; </span>
          <a class="fl_r pr1" >v{{ version }}</a>
          <a class="fl_r pr1" href="mailto:asu@alfa33.ru">Alfa <span class="fnt_0_6 pr1">решения в области промышленной автоматизации</span> 2023</a>
      </footer> 
      <div id="loader">
          <script>const loader=document.getElementById("loader");</script>
          <link rel="stylesheet" type="text/css" href="/css/loader.css"/>
      </div>
</body>
<script>
    moment.locale('ru');
    const STATUS_LIGHT_COLORS=['#e6e6e6','#b4b4b4','#fff134','#03e003']
    const STATUSES =['N/A', 'Откл', 'Простой', 'Работа']
    const MACHINE_ID={{ machine }}
    const WS_SERVER = '{{ wsserv }}';
    {% autoescape None %}
    const IDLE_COUSES={{  idle_couses  }}
    const STATE_CHANNEL='{{state_channel}}'
    const SUBSCRIBE_CHANNELS=[STATE_CHANNEL]
    const WORK_STATE=3
    const STAND_STATE=2
    const OFF_STATE=1
    const NA_STATE=1
    var currentState={{current_state}}
    
    console.log('start')  
    
    var stateElem
    var stateTimeElem
    var causeStatusElem
    var state
    var stateTime
    var currentCause
    var currentCauseTime

    const FlashColor='rgb(255, 0, 0)'
    var FlashBackgroundColor

    const wsStatus=document.getElementById("wsStatus")
    const wsIndicator=document.getElementById("wsLight")
    
    class PerodicalCallback {
        constructor(callback, delay) {
          this.callback = callback;
          this.delay=delay;
          this.remaining = delay;
          this.resume();
        }
        
        pause() {
          this.paused = true;
          window.clearInterval(this.id);
          this.remaining -= new Date() - this.start;
        }
        
        restart() {
          this.remaining = this.delay;
          this.resume();
        }
        
        resume() {
          this.paused = false;
          this.start = new Date();
          window.clearInterval(this.id);
          this.id = window.setInterval(this.callback, this.remaining);
        }
      }

    
    function block(innerHTML=undefined, classes=[], id=undefined, ){
      let block=document.createElement('div');
      if (id !=undefined) block.id=id;
      if (innerHTML !=undefined) block.innerHTML=innerHTML;
      block.classList=classes;
      return block;
    }
    function labledDataBlock(label, blockClasses=[],labelClasses=[],dataClasses=[], blockID=undefined, labelID=undefined, dataID=undefined){
        let container=block('',blockClasses,blockID);
        container.append(block(label,labelClasses,labelID));
        container.append(block('',dataClasses,dataID));
        return container
    }
    function labled2DataBlock(label, blockClasses=[],labelClasses=[],data1Classes=[], data2Classes=[], blockID=undefined, labelID=undefined, data1ID=undefined, data2ID=undefined, flexDirection='row'){
        let container=block('',blockClasses,blockID);
        container.append(block(label,labelClasses,labelID));
        let flexCls=(flexDirection=='row') ? 'flex_milldle_row':'flex_milldle_col'
        let dataContainer=block('',[flexCls],'');
        data1=block('',data1Classes,data1ID)
        data2=block('',data2Classes,data2ID)
        dataContainer.append(data1);
        dataContainer.append(data2);
        container.append(dataContainer);
        return container
    }
    function flashIndicator(indicator, flashColor,afterColor, pause){
      indicator.style.color=flashColor
      setTimeout(function(){indicator.style.color=afterColor},pause)
    }
    
    const secondsTimer=new PerodicalCallback ("updateTime()", 1000);

    function wsConnect(WSServer){
      let ws=new WebSocket(WSServer);
      wsStatus.textContent='online'
      wsIndicator.style.color='green'
      return ws
        // return new WebSocket(WSServer);
    }

    function wsEvents(){
      ws.onmessage = function(evt) {
        let jsonMsg = JSON.parse(evt.data);
        console.log(jsonMsg)
        switch (jsonMsg.cmd) {
          case "reload":
              //console.log(jsonMsg.data)
              location.reload()
          break;
          default:
        }
        currentState=jsonMsg[0][STATE_CHANNEL]
        setStatus(stateElem,currentState)
        stateTime=moment();                                   //todo взять из запроса
        setCauseStatusContDisplay(currentState)
        if (currentState==WORK_STATE){
          currentCause=undefined;
          stopFlashIdleBox()
        }
        // stateElem.dataset.stateTime=statusTime;
        //secondsTimer.restart()
        switch (jsonMsg.type) {
          //case "mb_data": 
          //console.log("mb_data")
          //console.log(jsonMsg)
          //makeTable(jsonMsg.data)
          
          // break; 
          case "ch_data":
            //console.log(jsonMsg.data)
            setDataById(jsonMsg.data)
            
          break;
          // default:
        }
        flashIndicator(wsIndicator,'lightgreen','green',400);
      };
        
    
      ws.onclose = function(evt) {
          console.log(' Server close connection! No data!')
          wsStatus.textContent='offline'
          wsIndicator.style.color='Red'
      };

      ws.onopen = function(evt) {
          console.log(' Connection ok, send subscribe msg: ' + SUBSCRIBE_CHANNELS)
          wsSend(JSON.stringify({type:"subscribe",data:SUBSCRIBE_CHANNELS}))
      };
    } 

    let wsSend = function(data) {
          if(!ws.readyState){
              setTimeout(function (){
                  wsSend(data);
              },1000);
          }else{
            ws.send(data);
          }
    };


    function setStatus(elem,result){
        elem.style.color=STATUS_LIGHT_COLORS[result];
        elem.innerText=STATUSES[result];
    }
    
    function startFlashIdleBox(){
      causeStatusContElem.classList.add('flashBackground')
    }
    function stopFlashIdleBox(){
      causeStatusContElem.classList.remove('flashBackground')
    }
    function clickHandler(event){
      let couseID=event.target.dataset.id;
      wsSend(JSON.stringify({type:"set",arg:"17001.cause_id", val:couseID}))
      stopFlashIdleBox();
      causeStatusElem.innerText=IDLE_COUSES[couseID]
    }

    function setCauseStatus(cause,causeTime){
      causeStatusElem
    }
    function setCauseStatusContDisplay(state){
      if (state!=NA_STATE && state!=WORK_STATE){
          causeStatusContElem.style.display='block'
          if (currentCause==undefined){
            startFlashIdleBox();
          }
          
        } else {
          causeStatusContElem.style.display='none'
        }
    }

    function makePage(){
        //console.log('shiftmode-',shiftMode)
        let page= document.getElementById('container');
        page.innerHTML='';
        let container=document.createElement('div');
        container.classList=['mainContainer'];
        page.append(container);
        const statusContainer = block('',['statusContainer'],'');
        container.append(statusContainer);
        statusContainer.append(labled2DataBlock('состояние',['h100 w100 databox'],['dataCaption'],['dataLable'],['dataLable'],'','','state_'+MACHINE_ID,'stateTime_'+MACHINE_ID, 'row'))
        statusContainer.append(labled2DataBlock('простой',['h100 w100 databox'],['dataCaption'],['dataLable'],['dataLable'],'causeStatus','','cause_'+MACHINE_ID,'causeTime_'+MACHINE_ID, 'row'))
        const buttonsContainer = block('',[],'buttonsContainer');
        for (i=0; i<Object.keys(IDLE_COUSES).length;i++){
          let id=Object.keys(IDLE_COUSES)[i]
          let cause=IDLE_COUSES[id]
          button=block(cause,['h100 w100 flex_center databox dataLable '],'buttonsContainer');
          button.dataset.id=id
          button.addEventListener('click', clickHandler);
          buttonsContainer.append(button)
        }
        container.append(buttonsContainer);
       
    }
    function updateTime(){
        let d=moment.duration(moment().diff(stateTime),'ms')
        stateTimeElem.innerText=  d.hours() + ':' + d.minutes() + ':'+d.seconds()
    }
    function init(){
        makePage()
        stateElem=document.getElementById('state_'+parseInt(MACHINE_ID))
        stateTimeElem=document.getElementById('stateTime_'+parseInt(MACHINE_ID))
        causeStatusContElem=document.getElementById('causeStatus')
        causeStatusElem=document.getElementById('cause_'+parseInt(MACHINE_ID))
        causeStatusTimeElem=document.getElementById('causeTime_'+parseInt(MACHINE_ID))
        state=currentState.state
        setStatus(stateElem,state);
        stateTime=moment(currentState.begin_time);
        currentCause=(state==OFF_STATE && state==STAND_STATE)?currentState.cause_id:undefined;
        currencurrentCauseTimetCause=(state==OFF_STATE && state==STAND_STATE)?currentState.cause_time:undefined;
        setCauseStatusContDisplay(state)
        secondsTimer.restart()
        ws=wsConnect(WS_SERVER);
        wsEvents();

    }
    
    init()
</script>
</html>